{% extends "process_dojo/base.html" %}

{% block title %}{{ video.title }}{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .video-player-section {
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 12px var(--shadow);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .video-player {
        width: 100%;
        background-color: #000;
        position: relative;
    }
    
    .video-player video {
        width: 100%;
        display: block;
        max-height: 70vh;
    }
    
    .video-info-section {
        padding: 2rem;
    }
    
    .video-header {
        margin-bottom: 1.5rem;
    }
    
    .video-title-large {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    .video-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        color: var(--dark-gray);
        font-size: 0.9rem;
    }
    
    .video-meta-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    
    .feature-tags {
        display: flex;
        gap: 0.8rem;
        margin-top: 1rem;
    }
    
    .feature-tag {
        padding: 0.4rem 0.9rem;
        background-color: var(--light-gray);
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-dark);
    }
    
    .feature-tag.active {
        background: linear-gradient(135deg, var(--light-coral) 0%, var(--primary-coral) 100%);
        color: var(--white);
    }
    
    .progress-section {
        background: linear-gradient(135deg, var(--light-coral) 0%, var(--primary-coral) 100%);
        padding: 1.5rem 2rem;
        border-radius: 8px;
        color: var(--white);
        margin-bottom: 2rem;
    }
    
    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .progress-title {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .progress-percentage-large {
        font-size: 2rem;
        font-weight: 700;
    }
    
    .progress-bar-large {
        width: 100%;
        height: 12px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background-color: var(--white);
        border-radius: 6px;
        transition: width 0.5s ease;
    }
    
    .progress-details {
        display: flex;
        justify-content: space-between;
        margin-top: 0.8rem;
        font-size: 0.9rem;
    }
    
    .completion-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-icon {
        font-size: 1.5rem;
    }
    
    .description-section {
        background-color: var(--white);
        border-radius: 8px;
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 8px var(--shadow);
        margin-bottom: 2rem;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--medium-gray);
    }
    
    .description-text {
        color: var(--dark-gray);
        line-height: 1.7;
        font-size: 1rem;
    }
    
    .test-section {
        background-color: var(--white);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px var(--shadow);
        text-align: center;
    }
    
    .test-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .test-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.8rem;
    }
    
    .test-description {
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }
    
    .test-requirements {
        background-color: var(--light-gray);
        border-radius: 6px;
        padding: 1.2rem;
        margin-bottom: 1.5rem;
        text-align: left;
    }
    
    .requirement-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.5rem 0;
        font-size: 0.95rem;
    }
    
    .requirement-icon {
        font-size: 1.2rem;
    }
    
    .requirement-icon.complete {
        color: var(--success-green);
    }
    
    .requirement-icon.incomplete {
        color: var(--dark-gray);
    }
    
    .btn-test {
        display: inline-block;
        padding: 1rem 2.5rem;
        background: linear-gradient(135deg, var(--success-green) 0%, #00aa55 100%);
        color: var(--white);
        border-radius: 6px;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.1rem;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 204, 102, 0.3);
    }
    
    .btn-test:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 204, 102, 0.4);
    }
    
    .btn-test:disabled,
    .btn-test.disabled {
        background: var(--dark-gray);
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .btn-test:disabled:hover,
    .btn-test.disabled:hover {
        transform: none;
    }
    
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1.2rem;
        background-color: var(--light-gray);
        color: var(--text-dark);
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.3s ease;
        margin-bottom: 1.5rem;
    }
    
    .btn-back:hover {
        background-color: var(--medium-gray);
    }
    
    .alert-info {
        background-color: #e6f3ff;
        border-left: 4px solid var(--primary-coral);
        padding: 1rem 1.2rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        color: #004466;
    }
    
    /* Completion Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .completion-modal {
        background-color: var(--white);
        border-radius: 12px;
        padding: 2.5rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.4s ease-out;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        animation: celebrate 0.6s ease-in-out;
    }
    
    @keyframes celebrate {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    
    .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.8rem;
    }
    
    .modal-message {
        color: var(--dark-gray);
        font-size: 1.1rem;
        margin-bottom: 2rem;
        line-height: 1.6;
    }
    
    .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-modal-primary {
        padding: 0.9rem 2rem;
        background: linear-gradient(135deg, var(--success-green) 0%, #00aa55 100%);
        color: var(--white);
        border: none;
        border-radius: 6px;
        font-weight: 700;
        font-size: 1.05rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 204, 102, 0.3);
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-modal-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 204, 102, 0.4);
    }
    
    .btn-modal-secondary {
        padding: 0.9rem 2rem;
        background-color: var(--light-gray);
        color: var(--text-dark);
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 1.05rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .btn-modal-secondary:hover {
        background-color: var(--medium-gray);
    }
    
    @media (max-width: 768px) {
        .video-info-section {
            padding: 1.5rem;
        }
        
        .video-title-large {
            font-size: 1.4rem;
        }
        
        .progress-section {
            padding: 1.2rem;
        }
        
        .test-section {
            padding: 1.5rem;
        }
        
        .completion-modal {
            padding: 2rem;
            width: 95%;
        }
        
        .modal-title {
            font-size: 1.5rem;
        }
        
        .modal-message {
            font-size: 1rem;
        }
        
        .modal-buttons {
            flex-direction: column;
        }
        
        .btn-modal-primary,
        .btn-modal-secondary {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'process_dojo:dashboard' %}">Dashboard</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <a href="{% url 'process_dojo:unit_detail' video.operation.line.unit.id %}">{{ video.operation.line.unit.name }}</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <a href="{% url 'process_dojo:line_detail' video.operation.line.id %}">{{ video.operation.line.name }}</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <a href="{% url 'process_dojo:operation_detail' video.operation.id %}">{{ video.operation.name }}</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <span>{{ video.title }}</span>
</div>
{% endblock %}

{% block content %}
<div class="video-container">
    <a href="{% url 'process_dojo:operation_detail' video.operation.id %}" class="btn-back">
        ‚Üê Back to {{ video.operation.name }}
    </a>
    
    <!-- Video Player -->
    <div class="video-player-section">
        <div class="video-player">
            <video id="training-video" controls>
                <source src="{{ video.video_file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        
        <div class="video-info-section">
            <div class="video-header">
                <h1 class="video-title-large">{{ video.title }}</h1>
                <div class="video-meta">
                    <div class="video-meta-item">
                        <span>üìç</span>
                        <span>{{ video.operation.name }}</span>
                    </div>
                    {% if video.duration_seconds > 0 %}
                    <div class="video-meta-item">
                        <span>‚è±Ô∏è</span>
                        <span>{{ video.duration_seconds|floatformat:0 }} seconds</span>
                    </div>
                    {% endif %}
                    <div class="video-meta-item">
                        <span>üëÅÔ∏è</span>
                        <span>Viewed {{ completion.access_count }} time{% if completion.access_count != 1 %}s{% endif %}</span>
                    </div>
                </div>
                
                <div class="feature-tags">
                    <span class="feature-tag {% if video.has_voice %}active{% endif %}">
                        üîä Voice Instructions
                    </span>
                    <span class="feature-tag {% if video.has_callouts %}active{% endif %}">
                        üìå Visual Callouts
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Section -->
    <div class="progress-section">
        <div class="progress-header">
            <div class="progress-title">Your Training Progress</div>
            <div class="progress-percentage-large" id="progress-display">
                {{ completion.completion_percentage|floatformat:0 }}%
            </div>
        </div>
        <div class="progress-bar-large">
            <div class="progress-bar-fill" id="progress-bar" style="width: {{ completion.completion_percentage }}%"></div>
        </div>
        <div class="progress-details">
            <div class="completion-status">
                {% if completion.is_completed %}
                <span class="status-icon">‚úì</span>
                <span>Training Completed</span>
                {% else %}
                <span class="status-icon">‚è≥</span>
                <span>In Progress</span>
                {% endif %}
            </div>
            <div>Last watched: {{ completion.last_watched_at|date:"M d, Y H:i" }}</div>
        </div>
    </div>
    
    <!-- Description -->
    {% if video.description %}
    <div class="description-section">
        <h2 class="section-title">About This Training</h2>
        <p class="description-text">{{ video.description }}</p>
    </div>
    {% endif %}
    
    <!-- Test Section -->
    {% if mcq_test %}
    <div class="test-section" id="test-section">
        <div class="test-icon">üìù</div>
        <h2 class="test-title">{{ mcq_test.title }}</h2>
        <p class="test-description">{{ mcq_test.description|default:"Test your knowledge of this training module." }}</p>
        
        <div class="test-requirements">
            <div class="requirement-item">
                <span class="requirement-icon {% if completion.is_completed %}complete{% else %}incomplete{% endif %}">
                    {% if completion.is_completed %}‚úì{% else %}‚óã{% endif %}
                </span>
                <span>Complete watching the video (100%)</span>
            </div>
            <div class="requirement-item">
                <span class="requirement-icon complete">‚úì</span>
                <span>{{ mcq_test.questions.count }} questions | {{ mcq_test.time_limit_minutes }} minutes</span>
            </div>
            <div class="requirement-item">
                <span class="requirement-icon complete">‚úì</span>
                <span>Passing score: {{ mcq_test.passing_score }}%</span>
            </div>
        </div>
        
        {% if completion.is_completed %}
        <a href="{% url 'process_dojo:start_test' video.id %}" class="btn-test">
            Take Test Now ‚Üí
        </a>
        {% else %}
        <button class="btn-test disabled" disabled id="test-btn-disabled">
            Complete Video to Take Test
        </button>
        <div class="alert-info" style="margin-top: 1rem;">
            Please watch the complete video before attempting the test.
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="alert-info">
        üìù No test is available for this training video yet.
    </div>
    {% endif %}
</div>

<!-- Completion Modal -->
{% if mcq_test %}
<div class="modal-overlay" id="completion-modal">
    <div class="completion-modal">
        <div class="modal-icon">üéâ</div>
        <h2 class="modal-title">Congratulations!</h2>
        <p class="modal-message">
            You've successfully completed the training video. 
            Ready to test your knowledge?
        </p>
        <div class="modal-buttons">
            <a href="{% url 'process_dojo:start_test' video.id %}" class="btn-modal-primary">
                Take Test Now ‚Üí
            </a>
            <button class="btn-modal-secondary" onclick="closeModal()">
                Later
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Video progress tracking
const video = document.getElementById('training-video');
const progressBar = document.getElementById('progress-bar');
const progressDisplay = document.getElementById('progress-display');
const completionModal = document.getElementById('completion-modal');
const videoId = {{ video.id }};
const hasTest = {% if mcq_test %}true{% else %}false{% endif %};
const wasAlreadyCompleted = {{ completion.is_completed|yesno:"true,false" }};

let updateTimeout;
let videoJustCompleted = false;

video.addEventListener('timeupdate', function() {
    if (video.duration > 0) {
        const percentage = (video.currentTime / video.duration) * 100;
        
        // Update UI immediately
        progressBar.style.width = percentage + '%';
        progressDisplay.textContent = Math.round(percentage) + '%';
        
        // Debounce server updates
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(function() {
            updateProgress(percentage);
        }, 2000);
    }
});

video.addEventListener('ended', function() {
    updateProgress(100);
});

function updateProgress(percentage) {
    fetch("{% url 'process_dojo:update_video_progress' video.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'percentage=' + percentage
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.is_completed) {
            // Show modal if video just completed and wasn't completed before
            if (!wasAlreadyCompleted && !videoJustCompleted && hasTest) {
                videoJustCompleted = true;
                showCompletionModal();
            }
        }
    })
    .catch(error => console.error('Error updating progress:', error));
}

function showCompletionModal() {
    if (completionModal) {
        completionModal.classList.add('active');
        
        // Update test section UI
        const testSection = document.getElementById('test-section');
        if (testSection) {
            // Update completion status
            const statusIcons = testSection.querySelectorAll('.requirement-icon.incomplete');
            statusIcons.forEach(icon => {
                icon.classList.remove('incomplete');
                icon.classList.add('complete');
                icon.textContent = '‚úì';
            });
            
            // Replace disabled button with active button
            const disabledBtn = document.getElementById('test-btn-disabled');
            if (disabledBtn) {
                const activeBtn = document.createElement('a');
                activeBtn.href = "{% url 'process_dojo:start_test' video.id %}";
                activeBtn.className = 'btn-test';
                activeBtn.textContent = 'Take Test Now ‚Üí';
                disabledBtn.parentNode.replaceChild(activeBtn, disabledBtn);
                
                // Remove info alert
                const alertInfo = testSection.querySelector('.alert-info');
                if (alertInfo) {
                    alertInfo.remove();
                }
            }
        }
        
        // Update progress section status
        const completionStatus = document.querySelector('.completion-status');
        if (completionStatus) {
            completionStatus.innerHTML = '<span class="status-icon">‚úì</span><span>Training Completed</span>';
        }
    }
}

function closeModal() {
    if (completionModal) {
        completionModal.classList.remove('active');
    }
}

// Close modal when clicking outside of it
if (completionModal) {
    completionModal.addEventListener('click', function(e) {
        if (e.target === completionModal) {
            closeModal();
        }
    });
}

// Keyboard navigation for modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && completionModal && completionModal.classList.contains('active')) {
        closeModal();
    }
});
</script>
{% endblock %}